import{j as p}from"./ui-Dwp8H4lk.js";import{P as O,S as G,r as W,E as K,C as Y,a as q,b as z,c as J,g as X,d as Z,D as ee,e as te,m as se,f as B,t as F,h as ae,i as ne,u as re,j as oe,k as le,l as ie,n as ce,o as ue,p as de,q as me,s as Ce,v as fe,w as ge}from"./index-debFNmPV.js";import{a as t}from"./vendor-CNWCjkky.js";import{c as he}from"./converters-DZGraCNg.js";import"./animations-DgOVmwgG.js";const pe=e=>{const[s,n]=t.useState(e),u=t.useCallback(c=>{n(C=>({...C,[c]:!C[c]}))},[]),m=t.useCallback(c=>!!s[c],[s]),o=t.useCallback((c,C)=>{n(f=>({...f,[c]:C}))},[]);return{states:s,toggleSection:u,isExpanded:m,setSection:o}};function be({open:e,onOpenChange:s,customer:n,onBack:u,onOpenFullDetails:m,totalItems:o,navigatePrevious:c,navigateNext:C,canNavigatePrevious:f,canNavigateNext:i}){const b=pe({customerDetails:!0,timeline:!0,balance:!0,orders:!1,paymentMethods:!1,activity:!1});return n?p.jsx(O,{id:"customer-details",open:e,children:p.jsx("div",{className:"h-full flex flex-col bg-muted",children:p.jsxs(G,{ariaLabel:"Customer details content",children:[p.jsx(K,{entityInfo:he(n),config:z,metadataComponent:q,actionsComponent:Y,onBack:u??(()=>s(!1)),currentEntityId:n.id,onOpenFullDetails:m,totalItems:o,navigatePrevious:c,navigateNext:C,canNavigatePrevious:f,canNavigateNext:i}),W({sections:b})]})})}):p.jsx(O,{id:"customer-details",open:e,children:p.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:"No customer selected"})})}function ye({data:e,selectedItems:s,onSelectionChange:n,onRowClick:u,pagination:m,loading:o,statusFilter:c,emptyStateDescription:C,managedColumns:f,onViewCustomer:i,onCopyId:b,onCreatePayment:I,onCreateSubscription:E,onCreateInvoice:M,onViewProfile:x,onFlag:g,onAddNote:P,onBlock:L,activeItemId:N}){const T=t.useMemo(()=>f?J(Object.values(te),f):X(c||"all"),[f,c]),D=t.useMemo(()=>e.filter(h=>["terminated","suspended"].includes(h.status)).map(h=>h.id),[e]),S=t.useMemo(()=>Z({onViewCustomer:i,onCopyCustomerId:b,onCreatePayment:I,onCreateSubscription:E,onCreateInvoice:M,onViewProfile:x,onFlag:g,onAddNote:P,onBlock:L}),[i,b,I,E,M,x,g,P,L]);return p.jsx(ee,{data:e,columns:T,selectedItems:s,onSelectionChange:n,getItemId:h=>h.id,onRowClick:u,rowActions:S,pagination:m,loading:o,unavailableItems:D,emptyStateDescription:C,className:"bg-background",getItemStatus:h=>h.status||"unknown",activeItemId:N})}const A=e=>{if(e)return typeof e=="string"?new Date(e):e};function Ie({statusFilter:e="all",filters:s={},currentPage:n=1,pageSize:u=10,query:m=""}={}){const[o,c]=t.useState([]),[C,f]=t.useState(0),[i,b]=t.useState(0),[I,E]=t.useState(!0),[M,x]=t.useState(null),[g,P]=t.useState(n),[L,N]=t.useState({status:[]}),[T,D]=t.useState({status:[]}),S=t.useMemo(()=>se.map(l=>({...l,created:A(l.created)||new Date,lastPayment:A(l.lastPayment),lastActivity:A(l.lastActivity),restricted:A(l.restricted),terminated:A(l.terminated)})),[]),h=t.useCallback(l=>{let r=l;if(e&&e!=="all"){const a=B.getMappings("customer")[e]||[];r=r.filter(d=>a.includes(d.status))}if(s.customer){const a=String(s.customer).toLowerCase();r=r.filter(d=>[d.name,d.email,d.id].some(w=>w.toLowerCase().includes(a)))}if(m&&m.trim()){const a=m.toLowerCase().trim();r=r.filter(d=>[d.name,d.email,d.id].some(w=>w.toLowerCase().includes(a)))}return s.riskLevel&&s.riskLevel!=="all"&&(r=r.filter(a=>a.riskLevel===s.riskLevel)),s.verified!==void 0&&(r=r.filter(a=>a.verified===s.verified)),r},[e,s.customer,s.riskLevel,s.verified,m]),v=t.useCallback(async(l=g,r)=>{try{if(E(!0),x(null),await new Promise((y,k)=>{const $=setTimeout(y,300);r?.addEventListener("abort",()=>{clearTimeout($),k(new DOMException("Aborted","AbortError"))})}),r?.aborted)return;const a=h(S),d=(l-1)*u,w=a.slice(d,d+u),Q=a.reduce((y,k)=>(y[k.status]=(y[k.status]||0)+1,y),{}),H={status:Object.entries(Q).map(([y,k])=>({value:y,count:k}))};c(w),f(a.length),b(Math.ceil(a.length/u)),N(H)}catch(a){if(r?.aborted||a instanceof DOMException&&a.name==="AbortError")return;const d=a instanceof Error?a.message:"Failed to load customers";x(d),F.error(d),c([]),f(0),b(0)}finally{r?.aborted||E(!1)}},[g,u,h,S]),R=t.useCallback(async()=>{const l=new AbortController;await v(g,l.signal)},[v,g]);t.useEffect(()=>{const l=S.reduce((r,a)=>(r[a.status]=(r[a.status]||0)+1,r),{});D({status:Object.entries(l).map(([r,a])=>({value:r,count:a}))})},[S]),t.useEffect(()=>{P(n)},[n]),t.useEffect(()=>{const l=new AbortController;return v(g,l.signal),()=>{l.abort()}},[v,g]);const V=t.useCallback(()=>{const l=new AbortController;v(g,l.signal)},[g,v]);return{data:o,totalItems:C,totalPages:i,isLoading:I,error:M,facets:L,unfilteredFacets:T,refetch:R,retry:V}}function Se(){const e=ne("customer"),s=t.useCallback(i=>{F.info(`Customer detail view not implemented yet for ${i}`)},[]),n=t.useCallback(i=>{ae(i,"Customer")},[]),u=t.useCallback(i=>{F.success(`Customer ${i.name} has been blocked`)},[]),m=t.useCallback(i=>{F.info(`Customer ${i.name} has been flagged for review`)},[]),o=t.useCallback(i=>{F.info(`Add note dialog for ${i.name} would open here`)},[]),c=t.useCallback(e.handleBatchFlag,[e]),C=t.useCallback(e.handleBatchExport,[e]),f=t.useCallback(i=>{e.handleBatchUpdate(i,"blocked")},[e]);return{handleViewCustomer:s,handleCopyCustomerId:n,handleBlockCustomer:u,handleFlag:m,handleAddNote:o,handleBatchFlag:c,handleBatchExport:C,handleBatchBlock:f}}const j=oe(le),ve=["all","active","risky","in_review","restricted","terminated"],ke=()=>re({statusCardValues:ve,statusMappings:B.getMappings("customer"),sessionKeys:{statusFilter:"customer-status-filter",filters:"customers-filters"},queryUtils:{parseQueryStringToFilters:j.parseQueryStringToFilters,buildQueryString:j.buildQueryString}});function Me(){const e=ie(),s=ke(),n=Se(),u=ce({batchActions:{flag:n.handleBatchFlag,export:n.handleBatchExport,block:n.handleBatchBlock}}),m={header:{title:"Customers",description:"Manage and monitor your customers",primaryAction:{label:"Create Customer",icon:p.jsx(Ce,{className:"h-4 w-4"}),onClick:n.handleCreateCustomer}},statusFilters:B.getFilters("customer"),table:{component:ye,props:{onViewProfile:n.handleViewCustomer,onFlag:n.handleFlagCustomer,onAddNote:n.handleAddNote,onCopyId:n.handleCopyCustomerId}},tableFilters:{component:de,props:{entity:"customers",onBulkAction:u.handleBulkAction}}};return p.jsx(ue,{fetchData:me.getCustomersForNavigation,pageConfig:m,useFilters:()=>s,useSelection:()=>u,usePageSize:()=>e,animationKey:s.statusFilter,basePath:"/customers",renderPanel:o=>p.jsx(be,{open:o.open,onOpenChange:o.onOpenChange,customer:o.entity,onBack:o.onBack,onOpenFullDetails:o.onOpenFullDetails,totalItems:o.totalItems,navigatePrevious:o.navigatePrevious,navigateNext:o.navigateNext,canNavigatePrevious:o.canNavigatePrevious,canNavigateNext:o.canNavigateNext})})}const Pe=e=>e.name||e.email,U=(e,s="USD")=>ge(e,s,0),Le=e=>{switch(e){case"active":return"success";case"risky":return"warning";case"in_review":case"pending_review":return"default";case"restricted":case"suspended":return"warning";case"terminated":case"closed":return"error";default:return"default"}},Ne=e=>{const s=e.paymentCount>0?e.totalSpent/e.paymentCount:0;return{avgOrderValue:s,formattedTotalSpent:U(e.totalSpent),formattedAvgOrderValue:U(s),paymentCount:e.paymentCount}},_={totalSpent:1e5,paymentCount:50},Te=e=>e.totalSpent>_.totalSpent||e.paymentCount>_.paymentCount,De=fe;export{ye as CustomerTable,Me as CustomersListPage,Ne as calculateCustomerMetrics,Pe as formatCustomerName,U as formatCustomerSpending,De as formatLastPayment,Le as getCustomerStatusVariant,Te as isHighValueCustomer,Se as useCustomerActions,ke as useCustomerFilters,Ie as useCustomers};
